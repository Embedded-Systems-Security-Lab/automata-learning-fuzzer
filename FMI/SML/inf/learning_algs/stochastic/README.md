This code is directly from AALPy library
